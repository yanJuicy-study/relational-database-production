# 06 도메인 설계 전략

DB 설게에서 가장 어려운 것이 바로 도메인 설계다.

어떤 속성이 필요한지 생각할 때 결정해야 할 것은 두 가지다.

한 개는 이름이고 또 하나는 데이터형, 즉 도메인이다.

이름은 단순한 꼬리표일 뿐이고 속성을 특정 짓는 것은 도메인이다.

# 도메인

## 도메인이란

도메인이란 관계형 모델에서 데이터형에 불과하다. 그리고 도메인의 집합으로 정의된다.

즉 도메인은 속성이 취할 수 있는 값의 집합이다.

도메인의 요소에 어던 구조를 가진 데이터를 할당할 것인지는 관계형 모델상의 제한은 없다.

## 집합의 요소

어떤 구조를 가진 데이터여도 상관없지만, 집합의 요소로 정의할 필요가 있으므로 명확한 값을 가진 것에 한한다.

NULL이나 포인터는 집합의 요소로써 사용할 수 없으므로 도메인의 요소로 쓸 수 없다.

# 도메인 설계 전략의 개요

도메인 설계에 필요한 것은 논리가 아니라 전략이나 철학과 같은 것들이다.

## 모든 것은 자의적인 선택

각 속성에 어떤 값이 적합한지 생각하는 것은 설계자의 업무다.

도메인 설계는 상식, 지금까지의 경험, 기세 등으로 결정할 수도 있다. 이와 같은 주관에 따라서 결정하는 것 외에는 방법이 없다.

## 응용프로그램의 필요성으로 생겨난다

속성이 어떤 값을 얻을 수 있는지 결정하는 것은 응용프로그램이다.

처음 필요한 것은 응용프로그램에 어떤 데이터가 필요한지 인식하는 것이다.

이것은 각 도메인의 설계뿐만 아니라 DB 전체의 설계에도 해당한다.

DB 쪽의 설계를 수행하기에 앞서 응용프로그램의 설계, 앱이 무엇을 수행하고 어떤 데이터가 입출력되며 이를 위해서 어떤 데이터를 영속화해야 하는지 찾아내야한다.

### 적절한 DB 설계를 위해 필요한 것

응용프로그램의 요건이나 구현된 로직을 깊이 이해하고 있어야 그에 적합한 DB 설계를 할 수 있다.

먼저 확실하게 응용프로그램을 설계할 수 있는 능력을 키우는 것이 DB 설계를 성공시킬 수 있는 전제 조건이라고 할 수 있다.

### 도메인 주도 설계

뛰어난 응용프로그램을 설계하려면 응용프로그램의 설계 방법을 익혀야 한다.

도메인 주도 설계가 그 중에 하나다.

도메인 주도 설계는 응용프로그램의 본질이 무엇인가에 이르기 위한 설계 방법이다.

### DB의 리팩터링

응용프로그램의 개발에는 여러 번의 리팩터링을 실시한다.

리팩터링으로 응용프로그램의 구조적인 변화가 있을 때는 DB 설계도 그에 맞게 바꿔야 한다.

응용프로그램뿐만 아니라 DB도 리팩터링을 해야 한다.

## 데이터의 본질을 파악한다

### 숫자 값에 문자열 칼럼을 할당하는 실수에 관한 예

학번 ID는 양의 정수 값을 사용해야 한다.

ID가 숫자 값인데도 문자열의 칼럼을 할당하는 경우가 있다.

이런 설계 이유는 학번의 자릿수가 정해져 있다는 생각 대문이다.

- 예를 들어 학번은 8자리의 숫자 값이므로 CHAR(8)이 적합하다고 판단한다.

불행히도 이는 설득력 있는 설계가 아니다.

### DB는 본질적인 데이터를 처리하게 한다

8자리라는 선택은 당분간 전교생을 나타내기에 충분하다고 생각된다.

미래를 생각하면 더 크게 확보해도 되지만, 불필요하게 자릿수를 사용하고 싶지 않다는 필요성이 있다.

하지만 자릿수는 표현상의 문제다.

본질적인 의미가 있는 데이터는 어디까지나 숫자 값이다.

DB에 표시상의 문제인 자릿수를 넣으려는 것은 잘못된 생각이다.

도메인을 설계할 때는 자릿수와 같은 표시상의 문제나 사용자의 편리성 등 본질적인 데이터를 확실하게 구별해야한다.

DB가 다루는 것은 본질적인 데이터다.

## 속성(칼럼)의 이름

앞에서는 속성의 이름에 “명명 규칙을 통일한다”, “주어를 포함한다”와 같은 노하우를 소개했다.

가장 중요한 점은 속성이 나타내는 데이터의 본질을 표현하는 이름을 사용하는 것이다.

각 속성의 의미가 정확하지 않으면 속성의 집합인 릴레이션이 나타내는 의미를 제대로 이해하는 것은 불가능할 것이다.

# ID를 설계한다는 개념

DB에 저장된 데이터 중에서 가장 일반적인 것이 ID다.

RDB를 능숙하게 다루려면 ID란 무엇인지, 어떻게 표현할 것인지 잘 이해해야 한다.

## 현실 세계의 물체나 개념을 나타내는 수단

DB의 저장된 ID는 현실 세계의 물체나 개념을 나타낸다.

![image](https://user-images.githubusercontent.com/43159295/210368810-0529d5cb-f091-4d90-897d-a55d1d3f7332.png)

그림과 같이 현실 세계의 물건과 속성이 1:1로 관계가 되는 용어를 집합론의 전단사 함수라고 한다.

위 그림의 집합은 ID로서 제대로 기능하지 않는다.

세상에는 많은 종류의 가위나 연필이 있고 같은 종류의 개체도 많이 존재한다.

따라서 위 그림은 현실의 물건을 나타내는 전단사 함수는 될 수 없고 현실 세계의 ID로 사용하는 것은 부적절하다.

그러나 관점을 바꾸면 ID로 사용할 수도 있다.

각 물건은 개체로서 유일하지 않지만, 가위라는 개념에 대한 꼬리표라고 생각하면 고유성을 보장할 수 있다.

다른 설계에서는 가위의 제품번호마다 꼬리표를 붙일 수도 있다.

ID를 설계하는 경우는 그것이 개체에 대한 것인지 집단에 대한 것인지, 집단이라면 어떤 크기로 집합을 식별화할지 등을 고려해야 한다.

### 자연키와 대체키

RDB에서 어떤 ID를 설계할 때 자연키로 해야 하는지, 대체키로 해야 하는지 논의하는 경우가 있다.

어느쪽도 RDB에서는 필요하며 상황에 따라서 구분해야 한다.

자연키란 세상에 존재하는 단어나 꼬리표를 키로 사용하는 것이다.

대리키는 세계에 없는 DB 또는 DB를 사용하는 응용프로그램 내부에서만 통용되는 ID다.

### 어느 쪽을 사용해야 하는가?

일반적으로 자연키가 바람직하지만 중복될 가능성이 있다고 알려졌다.

이름은 사람을 특정하는 데 사용하는 꼬리표이며 DB 밖의 세계에도 존재한다.

이름은 중복될 수 있다. 이름과 같은 예는 단순하게 ID로써 기능하지 않는 것을 키로 사용하면 실패한다는 예에 지나지 않는다.

ID로써 사용할 수 있다는 것, 현실 세계의 물건이나 개념과 1:1로 대응하는 집합이라면 자연키를 사용해도 문제가 없다.

### 자연키의 사용 대상과 문제점

DB 설계상 자연키를 사용하는 것은 문제가 되지 않는다.

문제는 사용값이 ID로써 기능할 수 있는지 아닌지다.

이미 누군가가 운영하고 무언가로 식별할 수 있고, 오랜 시간을 거친 값에 변경이 없고 신뢰할 수 있다고 생각되는 것은 자연키로 사용해도 문제가 없다.

ID가 무엇을 특정하는 것이냐는 관점도 중요하다.

자주 범하는 실수 중 하나로 이메일을 사람을 식별하는 ID로 사용하는 경우가 있다.

이메일 주소는 어디까지나 이메일 주소를 식별하는 것이며 사람을 특정하는 것은 아니다.

### 대체키의 사용 대상과 문제점

식별하고 싶은 대상의 물건이나 개념을 나타내는 ID가 아직 세상에 존재하지 않을 때가 많다.

각 주문을 식별하기 위한 ID는 세상에 존재하지 않는다.

이런 경우 새로운 시스템이 ID를 할당하는 데 아무런 문제가 없다. 여기 외에 사용할 수 있는 ID가 존재하지 않기 때문이다.

문제는 이미 자연키가 있는데 대체키를 새로 생성하는 경우다. 이런 대체키는 낭비다.

새롭게 대체키를 작성해도 본래의 자연키에 유니크 제약이 필요하다.

SQL은 해당 테이블을 갱신하면 유니크 키를 갱신하기 위한 오버헤드가 발생한다.

인덱스 갱신을 위한 오버헤드가 높아지므로 불필요한 인덱스는 피해야한다.
만약 갱신의 오버헤드가 싫어서 본래의 자연키에 유니크 제약을 제거하면 자연키에 중복이 발생할 수 있고 DB에 변칙이 생길 것이다.

이미 적절한 자연키가 존재할 때는 본질적으로 대체키는 불필요하다.

다른 일반적인 실수는 복합 기본키가 싫어서 대체키를 추가하는 경우다.

관계형 모델에서는 후보키가 여러 개의 속성으로 구성되는 게 지극히 자연스러운 것이다.

## 관계형 모델의 키

자연키나 대체키는 관계형 모델의 개념에는 없다.

관계형 모델에 있는 것은 후보키와 슈퍼키뿐이다.

키라는 기능은 단순히 튜플에 포함된 속성의 값을 유일하게 결정할 수 있다는 것에 지나지 않는다.

슈퍼키 중에 기약인 키가 후보키라는 것이다.

따라서 키가 자연키이든 대리키이든 마찬가지로 관계형 모델을 기반으로 한 설계 논리를 적용할 수 있다.

## 의미가 있는 ID

ID에 의미를 부여하는 설계를 자주 볼 수 있다.

- 제품 코드에 제품의 카테고리나 색상과 같은 특징을 담아서 여러 단어를 하이픈으로 이어놓은 것들이 그렇다.

이와 같은 ID는 현실의 물건과 1:1로 대입되면서 ID 기능이 있다.

하지만 DB에서 하나의 속성으로 다루기에는 문제가 있다.

특히 문제가 되는 것은 ID 일부분에 의존한 처리가 생길 때다.

- 어떤 전기제품의 제조업체가 파란색 사이클론식 청소기에 CNL-CYC-0123-BL 이라는 제품 코드를 할당했다.
- 이런 경우 파란색 청소기를 추출하려면 다음과 같은 쿼리를 작성해야 한다.

```sql
SELECT * FROM product_list WHERE product_id LIKE 'CNL%' AND product_id LIKE '%BL'
```

- 이러한 쿼리가 나오는 이유는 ID가 1NF의 요건을 만족하지 않기 때문이다.

이처럼 어떤 일부의 의미가 있는 ID는 1NF의 요건을 만족하지 않으므로 키로 사용하기에 부적절하다.

DB에서는 부분별로 나눈 값을 저장하고 제품 코드로 표시할 때는 값을 조합해 코드로 만드는 게 좋다.

# SQL로 도메인 표현

## 적절한 데이터형 선택

중요한 것은 적절한 SQL의 데이터형을 선택하는 것이다.

도메인 자체와 SQL의 각종 데이터형은 1:1로 대응하지 않지만 적어도 도메인이 가지는 값을 모두 포함할 수 있는 데이터형을 선택해야 한다.

수치라면 충분한 자릿수가 있는지 문자열이라면 충분한 길이를 가지는지 고려해야 한다.

## 술어를 제약으로 표현

칼럼이 도메인의 특징을 잘 표현하려면 도메인과 칼럼의 데이터형이 1:1 관계로 전단사 되어 있는 것이 바람직하다.

전사만으로는 그 칼럼의 도메인에 포함되지 않는 값도 저장할 수 있기 때문이다.

도메인과 칼럼의 대응을 단사에 가깝게 하는 방법으로 CHECK 제약 조건을 들 수 있다.

도메인 술어의 의미를 수식 등으로 표현할 수 있다면 CHECK 제약을 사용해 그 칼럼에 저장할 수 있는 데이터를 제한한다.

이를 통해 도메인에 포함되지 않는 값을 어느 정도 제거할 수 있다.
